<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Box Lu</title>
    <link rel="icon" type="image/png" href="immagini/magikarp.png">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style-box-lu.css">
</head>
<body> 

    <nav class="hamburger-menu">
    <input type="checkbox" id="menu-toggle" />
    <label for="menu-toggle" class="menu-button-container">
        <div class="menu-button"></div>
    </label>
    <ul class="menu-items">
            <li><a href="index.html">Home</a></li>
            <li><a href="page-didi.html">Didi</a></li>
            <li><a href="box-didi.html">Box Didi</a></li>
            <li><a href="page-lu.html">Lu</a></li>
            <li><a href="box-lu.html">Box Lu</a></li>
            <li><a href="matches.html">Fixtures</a></li>
        </ul>
</nav>

    <h1>Box Lu</h1>

    <div class="controls">
    <input type="text" id="searchInput" placeholder="Cerca Team o PokÃ©mon" oninput="applicaFiltri()">
    <select id="categoryFilter" onchange="applicaFiltri()">
    <option value="">Tutte le categorie</option>
</select>
    <select id="sortFilter" onchange="applicaFiltri()">
        <option value="default">Ordina per...</option>
        <option value="alpha">Alfabetico (A-Z)</option>
        <option value="win">Vittorie (Max)</option>
        <option value="loss">Sconfitte (Max)</option>
        <option value="setV">Set Vinti (Max)</option>
        <option value="setP">Set Persi (Max)</option>
        <option value="played">Partite Giocate (Max)</option>
    </select>
</div>

    <div class="grid" id="teamsGrid">
        <div class="loading">Caricamento dati dal PokÃ©dex...</div>
    </div>

    <div id="teamModal" class="modal" onclick="chiudiModale()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="chiudiModale()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <div id="pkmDetailModal" class="modal" onclick="chiudiPkmModal()">
    <div class="modal-content pkm-single-card" onclick="event.stopPropagation()">
        <span class="close" onclick="chiudiPkmModal()">&times;</span>
        <div id="pkmModalBody">
            </div>
    </div>
</div>

    <script>
    const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRBD7fZsWUtQ-UqcSaG-2lzeQnbxUdCUlTc8D6b4dCmSLq4-sDpIJGVzKmwwZF0p1uF-Ln3--4jpGk/pub?gid=589704271&single=true&output=csv';
    let tuttiITeam = [];

async function scaricaDati() {
    try {
        const response = await fetch(url + '&t=' + new Date().getTime());
        const data = await response.text();
        const righe = data.split(/\r?\n/).map(r => r.split(','));

        tuttiITeam = [];
        let categorieUniche = new Set(); 

        // Cicliamo su tutto lo spreadsheet saltando di 8 in 8
        for (let i = 0; i < righe.length; i += 8) {
            let nomeTeam = righe[i][0]?.trim();
            
            // Prendiamo la categoria (si trova sempre nella riga successiva al nome, colonna A)
            let cat = righe[i+1] && righe[i+1][0] ? righe[i+1][0].trim() : "";

            // Se la categoria esiste e non Ã¨ l'intestazione, la aggiungiamo al filtro
            // Lo facciamo PRIMA dei controlli sul nomeTeam cosÃ¬ le prende tutte
            if (cat && cat.toLowerCase() !== "categoria" && cat !== "N/A") {
                categorieUniche.add(cat);
            }

            // Controlli per visualizzare il team nella Home
            const isPlaceholder = /^D\d+$/i.test(nomeTeam);
            if (!nomeTeam || nomeTeam === "" || nomeTeam.toLowerCase() === "nome team" || isPlaceholder) {
                continue; 
            }

            let team = {
                id: i,
                nome: nomeTeam,
                categoria: cat || "N/A",
                vittorie: righe[i+3] ? righe[i+3][0].trim() : "0",
                sconfitte: righe[i+4] ? righe[i+4][0].trim() : "0",
                setVinti: righe[i+5] ? righe[i+5][0].trim() : "0",
                setPersi: righe[i+6] ? righe[i+6][0].trim() : "0",
                puntiFatti: righe[i+7] ? righe[i+7][0].trim() : "0",
                pokemon: []
            };

            for (let col = 1; col <= 6; col++) {
                let pName = righe[i][col]?.trim();
                if (pName) {
                    team.pokemon.push({
                        nome: pName,
                        abilita: righe[i+1] ? righe[i+1][col]?.trim() : "N/D",
                        strumento: righe[i+2] ? righe[i+2][col]?.trim() : "Nessuno",
                        mosse: [
                            righe[i+3] ? righe[i+3][col]?.trim() : "-",
                            righe[i+4] ? righe[i+4][col]?.trim() : "-",
                            righe[i+5] ? righe[i+5][col]?.trim() : "-",
                            righe[i+6] ? righe[i+6][col]?.trim() : "-"
                        ],
                        evs: righe[i+7] ? righe[i+7][col]?.trim() : "N/D"
                    });
                }
            }
            
            team.tuttoIlTesto = (team.nome + " " + team.categoria + " " + team.pokemon.map(p => p.nome).join(" ")).toLowerCase();
            tuttiITeam.push(team);
        }

        popolaFiltroCategorie(categorieUniche);
        renderizza(tuttiITeam);


        } catch (error) {
            console.error("Errore:", error);
            document.getElementById('teamsGrid').innerHTML = "Errore nel caricamento.";
        }
    }

async function coloraBordoDinamico(pkmName, elementId) {
    try {
        const cleanName = pkmName.toLowerCase().replace(/ /g, '-').replace(/[.'Ã©]/g, '');
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${cleanName}`);
        const data = await res.json();
        
        const coloriTipi = {
            fire: '#ff4422', water: '#3399ff', grass: '#77cc55', electric: '#ffcc33',
            ice: '#66ccff', fighting: '#bb5544', poison: '#aa5599', ground: '#ddbb55',
            flying: '#8899ff', psychic: '#ff5599', bug: '#aabb22', rock: '#bbaa66',
            ghost: '#6666bb', dragon: '#7766ee', dark: '#775544', steel: '#aaaabb',
            fairy: '#ee99ee', normal: '#aaaa99'
        };

        const tipi = data.types.map(t => coloriTipi[t.type.name]);
        const box = document.getElementById(elementId);
        if (!box) return;

        if (tipi.length === 1) {
            // Singolo tipo: bordo normale
            box.style.borderLeftColor = tipi[0];
        } else {
            // Doppio tipo: usiamo un gradiente lineare sul bordo
            // Per farlo funzionare su border-left dobbiamo usare border-image
            box.style.borderLeft = "6px solid"; // Aumentiamo un po' lo spessore per il doppio tipo
            box.style.borderImage = `linear-gradient(to bottom, ${tipi[0]} 50%, ${tipi[1]} 50%) 1 100%`;
        }
    } catch (e) {
        console.error("Errore tipi bordo:", e);
    }
}

function renderizza(lista) {
    const grid = document.getElementById('teamsGrid');
    grid.innerHTML = lista.map(team => `
        <div class="card" onclick="apriDettagli(${team.id})">
            <div class="card-header">
                <span class="category">${team.category || team.categoria}</span>
                <span class="stats">W: ${team.vittorie} / L: ${team.sconfitte}</span>
            </div>
            <h3>${team.nome}</h3>
            <div class="pkm-grid">
                ${team.pokemon.map((p, index) => {
                    const pkmNameUrl = p.nome.toLowerCase().replace(/ /g, '-').replace(/[.'Ã©]/g, '');
                    const itemNameUrl = p.strumento.toLowerCase().replace(/ /g, '-').replace(/[.'Ã©]/g, '');
                    const pkmSprite = `https://play.pokemonshowdown.com/sprites/ani/${pkmNameUrl.toLowerCase()}.gif`;
                    const itemSprite = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/${itemNameUrl}.png`;
                    const sideClass = (index % 2 === 0) ? 'left-side' : 'right-side';
                    const pkmBoxId = `box-${team.id}-${index}`;
                    
                    setTimeout(() => applicaColoreBordo(p.nome, pkmBoxId), 50);

                    // AGGIUNTO ONCLICK QUI SOTTO:
                    return `
                        <div class="pkm-box" id="${pkmBoxId}" onclick="event.stopPropagation(); apriPkmDettaglio(${JSON.stringify(p).replace(/"/g, '&quot;')}, '${pkmNameUrl}')">
                            <div class="pkm-sprite-container">
                                <img src="${pkmSprite}" class="pkm-sprite" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'">
                            </div>
                            <div class="pkm-info">
                                <span class="pkm-name">${p.nome}</span>
                                <div class="item-container">
                                    <img src="${itemSprite}" class="item-icon" title="${p.strumento}" onerror="this.style.display='none'">
                                    <span class="pkm-item">${p.strumento}</span>
                                </div>
                            </div>

                            <div class="pkm-hover-card ${sideClass}">
                                <strong>${p.nome}</strong>
                                <p>âœ¨ ${p.abilita}</p>
                                <p style="color: #1a1a1a; margin-bottom: 8px !important;">ðŸ“Š ${p.evs}</p>
                                <div class="hover-moves">
                                    ${p.mosse.map(m => `<span>${m}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `).join('');
}

async function caricaInfoAbilita(nomeAbilita, elementoId) {
    const tooltip = document.getElementById(elementoId);
    if (!nomeAbilita || tooltip.dataset.loaded === "true") return;

    try {
        const cleanName = nomeAbilita.toLowerCase().trim().replace(/\s+/g, '-').replace(/[.'Ã©]/g, '');
        const res = await fetch(`https://pokeapi.co/api/v2/ability/${cleanName}`);                 
        const data = await res.json();
        const effect = data.effect_entries.find(e => e.language.name === 'en')?.short_effect || "Descrizione non disponibile.";
        
        tooltip.innerHTML = `<p>${effect}</p>`;
        tooltip.dataset.loaded = "true";
    } catch (e) { tooltip.innerHTML = `</h3><p>Info non trovate.</p>`; }
}

async function caricaInfoStrumento(nomeStrumento, elementoId) {
    const tooltip = document.getElementById(elementoId);
    if (!nomeStrumento || tooltip.dataset.loaded === "true") return;

    try {
        const cleanName = nomeStrumento.toLowerCase().trim().replace(/\s+/g, '-').replace(/[.'Ã©]/g, '');
        const res = await fetch(`https://pokeapi.co/api/v2/item/${cleanName}`);
        const data = await res.json();
        const effect = data.effect_entries.find(e => e.language.name === 'en')?.short_effect || "Descrizione non disponibile.";
        
        tooltip.innerHTML = `<p>${effect}</p>`;
        tooltip.dataset.loaded = "true";
    } catch (e) { tooltip.innerHTML = `</h3><p>Info non trovate.</p>`; }
}

async function caricaInfoMossa(nomeMossa, elementoId) {
    const tooltip = document.getElementById(elementoId);
    
    // Se la mossa Ã¨ vuota o giÃ  caricata, non fare nulla
    if (!nomeMossa || nomeMossa.trim() === "-" || tooltip.dataset.loaded === "true") return;

    try {
        const cleanName = nomeMossa.trim().toLowerCase().replace(/\s+/g, '-').replace(/[.'Ã©]/g, '');
        const res = await fetch(`https://pokeapi.co/api/v2/move/${cleanName}`);
        
        if (!res.ok) throw new Error();
        const data = await res.json();
        
        // --- APPLICHIAMO IL COLORE AL TOOLTIP ---
        const tipo = data.type.name; 
        tooltip.className = `move-tooltip ${tipo}`; // Aggiunge la classe del tipo (es. "fire") al fumetto
        // ----------------------------------------

        const power = data.power || '--';
        const accuracy = data.accuracy ? data.accuracy + '%' : '--';
        let effect = data.effect_entries.find(e => e.language.name === 'en')?.short_effect || "Descrizione non disponibile.";
        if (data.effect_chance) effect = effect.replace('$effect_chance', data.effect_chance);

        tooltip.innerHTML = `
            <div style="font-weight:bold; margin-bottom:4px; border-bottom:1px solid rgba(255,255,255,0.4);">
                ${nomeMossa.toUpperCase()}
            </div>
            <b>POW:</b> ${power} &nbsp;&nbsp; <b>ACC:</b> ${accuracy}<br>
            <div style="margin-top:6px; font-style:italic; font-size:0.7rem; line-height:1.2;">${effect}</div>
        `;
        
        tooltip.dataset.loaded = "true";
    } catch (e) {
        tooltip.innerText = "Dati mossa non trovati.";
        tooltip.style.background = "#33261c"; // Colore di fallback in caso di errore
    }
}

async function apriDettagli(id) {
    const team = tuttiITeam.find(t => t.id === id);
    const modal = document.getElementById('teamModal');
    const content = document.getElementById('modalBody'); // <--- MANCAVA QUESTA RIGA!

    // Convertiamo in numeri per sicurezza (usando Number per gestire meglio i vuoti)
    const sV = Number(team.setVinti) || 0;
    const sP = Number(team.setPersi) || 0;
    const w = team.vittorie || 0;
    const l = team.sconfitte || 0;
    const pts = team.puntiFatti || 0;

    // Calcolo Partite Giocate: (Vinti + Persi) / 5
    const totSet = sV + sP;
    const partiteGiocate = totSet > 0 ? Math.floor(totSet / 5) : 0;
    content.innerHTML = `
        <div class="modal-header-container">
            <h2>${team.nome}</h2>
            <div class="team-score-banner">
                <div class="score-item"><span>W/L</span><strong>${w} - ${l}</strong></div>
                <div class="score-item"><span>Sets W/L</span><strong>${sV} - ${sP}</strong></div>
                <div class="score-item"><span>Points</span><strong>${pts}</strong></div>
                <div class="score-item"><span>Played</span><strong>${partiteGiocate}</strong></div>
            </div>
        </div>
        <div class="modal-grid">
            ${team.pokemon.map((p, pIndex) => {
                const pkmNameUrl = p.nome.toLowerCase().replace(/ /g, '-').replace(/[.'Ã©]/g, '');
                const mIdPrefix = `types-${pIndex}`;
                const statsId = `stats-${pIndex}`;
                const abiId = `abi-${pIndex}`;
                const itemId = `item-${pIndex}`;
                const direzioneTipi = pIndex < 3 ? 'v-down' : '';
                const classePosizione = ((pIndex + 1) % 3 === 0) ? 'tooltip-left' : '';
                
                caricaTipi(pkmNameUrl, mIdPrefix, direzioneTipi);
                
                return `
                <div class="modal-pkm-card" style="z-index: ${10 - pIndex}; position: relative;"
                     onmouseenter="this.style.zIndex='999'"
                     onmouseleave="this.style.zIndex='${10 - pIndex}'">
                    <div class="modal-left-column">
                        <div id="${mIdPrefix}" class="modal-types"></div>
                        <img src="https://play.pokemonshowdown.com/sprites/ani/${pkmNameUrl.toLowerCase()}.gif" class="modal-sprite clickable-pkm">
                    </div>
                    <div class="modal-pkm-info">
                        <div class="info-container" style="position: relative; display: inline-block;">
                            <strong style="cursor: help;" onmouseover="caricaStats('${pkmNameUrl}', '${statsId}')">${p.nome}</strong>
                            <div id="${statsId}" class="generic-tooltip ${classePosizione}">Caricamento...</div>
                        </div>
                        <div class="info-container" style="position: relative;">
                            <p>âœ¨ <em style="cursor: help;" onmouseover="caricaInfoAbilita('${p.abilita}', '${abiId}')">${p.abilita}</em></p>
                            <div id="${abiId}" class="generic-tooltip ${classePosizione}">Caricamento...</div>
                        </div>
                        <div class="info-container" style="position: relative;">
                            <div class="modal-item" style="cursor: help;" onmouseover="caricaInfoStrumento('${p.strumento}', '${itemId}')">
                                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/${p.strumento.toLowerCase().replace(/ /g, '-').replace(/[.'Ã©]/g, '')}.png" onerror="this.style.display='none'">
                                <span>${p.strumento}</span>
                            </div>
                            <div id="${itemId}" class="generic-tooltip ${classePosizione}">Caricamento...</div>
                        </div>
                        <p style="color:#1a1a1a; font-size:0.65rem; margin-top:2px !important;">ðŸ“Š ${p.evs}</p>
                        <div class="modal-moves">
                            ${p.mosse.map((m, mIndex) => {
                                const mId = `mossa-${pIndex}-${mIndex}`;
                                return `
                                <span class="move-span" onmouseover="caricaInfoMossa('${m}', '${mId}')">
                                    ${m}
                                    <div id="${mId}" class="move-tooltip">Caricamento...</div>
                                </span>`;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
            }).join('')}
        </div>
    `;
    modal.style.display = "flex";
}
// Listener per la tastiera (aggiungilo fuori dalla funzione apriDettagli)
document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('teamModal');
    if (modal.style.display === "flex") {
        const currentIndex = tuttiITeam.findIndex(t => t.id === window.currentTeamId);
        if (e.key === "ArrowLeft" && currentIndex > 0) {
            apriDettagli(tuttiITeam[currentIndex - 1].id);
        } else if (e.key === "ArrowRight" && currentIndex < tuttiITeam.length - 1) {
            apriDettagli(tuttiITeam[currentIndex + 1].id);
        } else if (e.key === "Escape") {
            modal.style.display = "none";
        }
    }
});


async function caricaStats(pkmName, elementId) {
    const tooltip = document.getElementById(elementId);
    if (tooltip.dataset.loaded === "true") return;

    try {
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${pkmName}`);
        const data = await res.json();
        
        const statsMap = {
            'hp': 'HP',
            'attack': 'ATK',
            'defense': 'DEF',
            'special-attack': 'SPA',
            'special-defense': 'SPD',
            'speed': 'SPE'
        };

        let statsHTML = `<div style="font-weight:bold; margin-bottom:8px; border-bottom:1px solid #eeeeee; font-size:0.8rem">BASE STATS</div>`;
        
        data.stats.forEach(s => {
            const val = s.base_stat;
            // Calcoliamo la larghezza della barra (max 150 per le stats base medie)
            const width = Math.min((val / 150) * 100, 100); 
            statsHTML += `
                <div class="stat-row">
                    <span style="width: 30px; font-weight:bold;">${statsMap[s.stat.name]}</span>
                    <span style="width: 25px; text-align:right;">${val}</span>
                    <div class="stat-bar-bg">
                        <div class="stat-bar-fill" style="width: ${width}%"></div>
                    </div>
                </div>`;
        });

        tooltip.innerHTML = statsHTML;
        tooltip.dataset.loaded = "true";
    } catch (e) {
        tooltip.innerText = "Error.";
    }
}

// Nuova funzione per scaricare i tipi
// Aggiunto "direzione" ai parametri
async function caricaTipi(pkmName, elementId, direzione) {
    try {
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${pkmName}`);
        const data = await res.json();
        const container = document.getElementById(elementId);
        if (!container) return;

        const d_types = ["normal","fire","water","electric","grass","ice","fighting","poison","ground","flying","psychic","bug","rock","ghost","dragon","dark","steel","fairy"];
        let effectiveness = {};
        d_types.forEach(type => effectiveness[type] = 1);

        await Promise.all(data.types.map(async (t) => {
            const typeRes = await fetch(t.type.url);
            const typeData = await typeRes.json();
            const rel = typeData.damage_relations;

            rel.double_damage_from.forEach(type => effectiveness[type.name] *= 2);
            rel.half_damage_from.forEach(type => effectiveness[type.name] *= 0.5);
            rel.no_damage_from.forEach(type => effectiveness[type.name] *= 0);
        }));

        let result = { x4: [], x2: [], x05: [], x025: [], x0: [] };
        for (let type in effectiveness) {
            const mult = effectiveness[type];
            if (mult === 4) result.x4.push(type);
            else if (mult === 2) result.x2.push(type);
            else if (mult === 0.5) result.x05.push(type);
            else if (mult === 0.25) result.x025.push(type);
            else if (mult === 0) result.x0.push(type);
        }

        const creaBadge = (lista) => {
            return `<div class="eff-badge-container">
                ${lista.map(t => `<span class="mini-type-badge ${t}">${t}</span>`).join('')}
            </div>`;
        };

        let tooltipHTML = "";
        if (result.x4.length > 0) tooltipHTML += `<div class="eff-section"><span class="eff-title v-4">4x</span>${creaBadge(result.x4)}</div>`;
        if (result.x2.length > 0) tooltipHTML += `<div class="eff-section"><span class="eff-title v-2">2x</span>${creaBadge(result.x2)}</div>`;
        if (result.x05.length > 0) tooltipHTML += `<div class="eff-section"><span class="eff-title v-05">0.5x</span>${creaBadge(result.x05)}</div>`;
        if (result.x025.length > 0) tooltipHTML += `<div class="eff-section"><span class="eff-title v-025">0.25x</span>${creaBadge(result.x025)}</div>`;
        if (result.x0.length > 0) tooltipHTML += `<div class="eff-section"><span class="eff-title v-0">0x</span>${creaBadge(result.x0)}</div>`;

        // --- APPLICAZIONE CLASSE DIREZIONE ---
        container.innerHTML = data.types.map(t => 
        `<div class="type-container">
            <span class="type-badge ${t.type.name}">${t.type.name.toUpperCase()}</span>
            <div class="type-effectiveness-tooltip ${direzione}">${tooltipHTML}</div>
        </div>`
    ).join('');

    } catch (e) { console.error("Errore:", e); }
}    

function chiudiModale() {
        document.getElementById('teamModal').style.display = "none";
    }

function applicaFiltri() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const cat = document.getElementById('categoryFilter').value;
    const sort = document.getElementById('sortFilter').value;

    // 1. Filtriamo per ricerca e categoria (i "D+numero" sono giÃ  esclusi a monte)
    let filtrati = tuttiITeam.filter(team => {
        const matchesSearch = team.tuttoIlTesto.includes(search);
        const matchesCat = cat === "" || team.categoria === cat;
        return matchesSearch && matchesCat;
    });

    // 2. Applichiamo l'ordinamento scelto
    filtrati.sort((a, b) => {
        switch (sort) {
            case 'alpha':
                return a.nome.localeCompare(b.nome);
            case 'win':
                return Number(b.vittorie) - Number(a.vittorie);
            case 'loss':
                return Number(b.sconfitte) - Number(a.sconfitte);
            case 'setV':
                return Number(b.setVinti) - Number(a.setVinti);
            case 'setP':
                return Number(b.setPersi) - Number(a.setPersi);
            case 'played':
                const playedA = Number(a.setVinti) + Number(a.setPersi);
                const playedB = Number(b.setVinti) + Number(b.setPersi);
                return playedB - playedA;
            default:
                // Ordine originale dello spreadsheet
                return 0;
        }
    });

    renderizza(filtrati);
}
    scaricaDati();

    async function applicaColoreBordo(pkmName, elementId) {
    const box = document.getElementById(elementId);
    if (!box) return;
    try {
        const cleanName = pkmName.toLowerCase().replace(/ /g, '-').replace(/[.'Ã©]/g, '');
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${cleanName}`);
        const data = await res.json();
        
        const colori = {
            fire: '#ff4422', water: '#3399ff', grass: '#77cc55', electric: '#ffcc33', ice: '#66ccff', fighting: '#bb5544', poison: '#aa5599', ground: '#ddbb55', flying: '#8899ff', psychic: '#ff5599', bug: '#aabb22', rock: '#bbaa66', ghost: '#6666bb', dragon: '#7766ee', dark: '#775544', steel: '#aaaabb', fairy: '#ee99ee', normal: '#aaaa99'
        };

        const types = data.types.map(t => colori[t.type.name]);

        // Applichiamo il colore allo pseudo-elemento ::before
        if (types.length === 1) {
            box.style.setProperty('--bordo-colore', types[0]);
            box.style.styleSheet ? "" : box.setAttribute('style', `background-left: none;`); // cleanup
            // Usiamo il background diretto sullo pseudo-elemento tramite una variabile o stile iniettato
            box.style.setProperty('--bg-bordo', types[0]);
        } else {
            box.style.setProperty('--bg-bordo', `linear-gradient(to bottom, ${types[0]} 50%, ${types[1]} 50%)`);
        }
        
        // Applichiamo lo stile finale
        const bgEffettivo = types.length === 1 ? types[0] : `linear-gradient(to bottom, ${types[0]} 50%, ${types[1]} 50%)`;
        
        // Creiamo una piccola regola stile al volo per colpire il ::before di quel box specifico
        const stileDinamico = document.createElement('style');
        stileDinamico.innerHTML = `#${elementId}::before { background: ${bgEffettivo} !important; }`;
        document.head.appendChild(stileDinamico);

    } catch (e) {
        console.error("Errore colore:", e);
    }
}


function apriPkmDettaglio(pokemonData, pkmNameUrl) {
    const modal = document.getElementById('pkmDetailModal');
    const content = document.getElementById('pkmModalBody');
    
    content.innerHTML = `
        <div class="pkm-modal-grid">
            <div class="area-header">
                <div id="single-types" class="types-centered"></div>
                <img id="pkm-hero-sprite" src="https://play.pokemonshowdown.com/sprites/ani/${pkmNameUrl.toLowerCase()}.gif" class="pkm-sprite-hero">
                <h2 class="pkm-name-banner">${pokemonData.nome}</h2>
            </div>

            <div class="area-weakness pkm-panel">
                <div style="font-weight:bold; color: #eeeeee; margin-bottom:8px; border-bottom:1px solid #eeeeee; font-size:0.8rem">DEFENSE</div>
                <div id="static-weaknesses" class="weakness-content">Caricamento...</div>
            </div>

            <div class="area-info-strips">
                <div class="pkm-panel info-box-compact">
                    <div class="info-content-clean">
                        <strong class="info-name">${pokemonData.abilita}</strong>
                        <div id="single-abi" class="info-desc-tiny"></div>
                    </div>
                </div>
                <div class="pkm-panel info-box-compact">
                    <div class="info-content-clean">
                        <div class="item-title-row-new">
                            <strong class="info-name">${pokemonData.strumento}</strong>
                            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/${pokemonData.strumento.toLowerCase().replace(/ /g, '-').replace(/[.'Ã©]/g, '')}.png" class="item-icon-right" onerror="this.style.display='none'">
                        </div>
                        <div id="single-item" class="info-desc-tiny"></div>
                    </div>
                </div>
            </div>

            <div class="area-stats pkm-panel">
                <div id="single-stats"></div>
                <div class="evs-footer"><strong>EVs:</strong> ${pokemonData.evs}</div>
            </div>

            <div class="area-moves pkm-panel">
                <h4 class="panel-title">MOVESET</h4>
                <div class="moves-list-compact">
                    ${pokemonData.mosse.map((m, i) => {
                        if(!m || m === "-") return '';
                        return `
                        <div class="move-row-mini" id="move-card-${i}">
                            <div class="move-left-part">
                                <span id="m-cat-${i}" class="move-cat-icon"></span>
                                <span class="move-name-mini">${m}</span>
                            </div>
                            <div id="sm-${i}" class="move-desc-inline"></div>
                            <div class="move-right-part">
                                <span class="m-val">P: <b id="m-pow-${i}">--</b></span>
                                <span class="m-val">A: <b id="m-acc-${i}">--</b></span>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>
        </div>
    `;

    modal.style.display = "flex";

    // RECUPERO ID PER GIF HD
    fetch(`https://pokeapi.co/api/v2/pokemon/${pkmNameUrl.toLowerCase()}`)
        .then(res => res.json())
        .then(data => {
            // Qui carichiamo la versione HOME ad alta risoluzione tramite ID
            document.getElementById('pkm-hero-sprite').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/${data.id}.gif`;
            
            // Carichiamo il resto dei dati
            caricaStats(pkmNameUrl, 'single-stats');
            caricaTipi(pkmNameUrl, 'single-types', '');
        });

    // GESTIONE MOSSE: Lingua Inglese + Colore
    pokemonData.mosse.forEach((m, i) => {
        if(m && m !== "-") {
            const mName = m.toLowerCase().replace(/ /g, '-');
            fetch(`https://pokeapi.co/api/v2/move/${mName}`)
                .then(res => res.json())
                .then(moveData => {
                    // FILTRO LINGUA INGLESE
                    const entry = moveData.flavor_text_entries.find(e => e.language.name === 'en');
                    if (entry) {
                        document.getElementById(`sm-${i}`).innerText = entry.flavor_text.replace(/[\n\f]/g, ' ').trim();
                    }
                });
            aggiornaColoreMossa(m, `move-card-${i}`, i);
        }
    });

    caricaDebolezzeStatiche(pkmNameUrl, 'static-weaknesses');
    caricaInfoAbilita(pokemonData.abilita, 'single-abi');
    caricaInfoStrumento(pokemonData.strumento, 'single-item');
}
    modal.style.display = "flex";

    // Esegui i caricamenti
    caricaTipi(pkmNameUrl, 'single-types', '');
    caricaDebolezzeStatiche(pkmNameUrl, 'static-weaknesses');
    caricaStats(pkmNameUrl, 'single-stats');
    caricaInfoAbilita(pokemonData.abilita, 'single-abi');
    caricaInfoStrumento(pokemonData.strumento, 'single-item');

    // CORREZIONE QUI: Passiamo l'indice 'i' correttamente alla funzione
    pokemonData.mosse.forEach((m, i) => {
        if(m && m !== "-") {
            aggiornaColoreMossa(m, `move-card-${i}`, i);
        }
    });

    function popolaFiltroCategorie(setInsieme) {
    const select = document.getElementById('categoryFilter');
    if (!select) return;

    // Reset del menu (tiene solo la prima opzione)
    select.innerHTML = '<option value="">Tutte le categorie</option>';
    
    // Ordina le categorie alfabeticamente
    const categorieOrdinate = Array.from(setInsieme).sort();
    
    categorieOrdinate.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
    });
}

async function aggiornaColoreMossa(nomeMossa, cardId, typeBadgeId) {
    if (!nomeMossa || nomeMossa === "-") return;
    try {
        const cleanName = nomeMossa.trim().toLowerCase().replace(/\s+/g, '-').replace(/[.'Ã©]/g, '');
        const res = await fetch(`https://pokeapi.co/api/v2/move/${cleanName}`);
        const data = await res.json();
        const index = cardId.split('-').pop();
        
        const coloriTipi = {
            fire: '#ff4422', water: '#3399ff', grass: '#77cc55', electric: '#ffcc33', ice: '#66ccff', 
            fighting: '#bb5544', poison: '#aa5599', ground: '#ddbb55', flying: '#8899ff', psychic: '#ff5599', 
            bug: '#aabb22', rock: '#bbaa66', ghost: '#6666bb', dragon: '#7766ee', dark: '#775544', 
            steel: '#aaaabb', fairy: '#ee99ee', normal: '#aaaa99'
        };

        const tipo = data.type.name;
        const colorePieno = coloriTipi[tipo] || '#ccc';
        const card = document.getElementById(cardId);

        card.style.backgroundColor = colorePieno;
        card.style.borderLeft = "none";
        card.classList.add('move-full-color');

        document.getElementById(`m-pow-${index}`).innerText = data.power || '--';
        document.getElementById(`m-acc-${index}`).innerText = data.accuracy ? data.accuracy : '--';

        // --- 3. INSERIMENTO IMMAGINI PERSONALIZZATE ---
        const catImgMap = { 
            physical: 'immagini/move-physical.png', 
            special: 'immagini/move-special.png', 
            status: 'immagini/move-status.png' 
        };
        
        const catContainer = document.getElementById(`m-cat-${index}`);
        if (catContainer) {
            const categoria = data.damage_class.name;
            const percorsoImmagine = catImgMap[categoria];
            // Creiamo il tag img invece di mettere l'emoji
            catContainer.innerHTML = `<img src="${percorsoImmagine}" class="cat-icon-render" alt="${categoria}">`;
        }

        // --- 4. DESCRIZIONE INGLESE ---
        const descElement = document.getElementById(`sm-${index}`);
        if (descElement) {
            let desc = data.flavor_text_entries.find(e => e.language.name === 'en');
            if (desc) {
                descElement.innerText = desc.flavor_text.replace(/[\n\f]/g, ' ');
            }
        }

    } catch (e) { 
        console.error("Errore caricamento mossa:", nomeMossa, e); 
    }
}

function chiudiPkmModal() {
    document.getElementById('pkmDetailModal').style.display = "none";
}

async function caricaDebolezzeStatiche(pkmName, elementId) {
    const container = document.getElementById(elementId);
    if (!container) return;

    try {
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${pkmName}`);
        const data = await res.json();
        
        // Lista completa dei tipi per il calcolo
        const tuttiITipi = ['normal', 'fire', 'water', 'electric', 'grass', 'ice', 'fighting', 'poison', 'ground', 'flying', 'psychic', 'bug', 'rock', 'ghost', 'dragon', 'dark', 'steel', 'fairy'];
        
        let effectiveness = {};
        tuttiITipi.forEach(type => effectiveness[type] = 1);

        await Promise.all(data.types.map(async (t) => {
            const typeRes = await fetch(t.type.url);
            const typeData = await typeRes.json();
            const rel = typeData.damage_relations;

            rel.double_damage_from.forEach(type => effectiveness[type.name] *= 2);
            rel.half_damage_from.forEach(type => effectiveness[type.name] *= 0.5);
            rel.no_damage_from.forEach(type => effectiveness[type.name] *= 0);
        }));

        // Raggruppiamo i risultati
        let result = { x4: [], x2: [], x05: [], x025: [], x0: [] };
        for (let type in effectiveness) {
            const mult = effectiveness[type];
            if (mult === 4) result.x4.push(type);
            else if (mult === 2) result.x2.push(type);
            else if (mult === 0.5) result.x05.push(type);
            else if (mult === 0.25) result.x025.push(type);
            else if (mult === 0) result.x0.push(type);
        }

        // Funzione interna per creare i micro-badge colorati
        const creaBadge = (lista) => `
    <div class="types-wrapper">
        ${lista.map(t => `<span class="mini-type-badge ${t}">${t}</span>`).join('')}
    </div>`;

container.innerHTML = `
    <div class="weakness-container">
        ${result.x4.length > 0 ? `<div class="w-row"><b class="mult x4">4x</b> ${creaBadge(result.x4)}</div>` : ''}
        ${result.x2.length > 0 ? `<div class="w-row"><b class="mult x2">2x</b> ${creaBadge(result.x2)}</div>` : ''}
        ${result.x05.length > 0 ? `<div class="w-row"><b class="mult x05">0.5x</b> ${creaBadge(result.x05)}</div>` : ''}
        ${result.x025.length > 0 ? `<div class="w-row"><b class="mult x025">0.25x</b> ${creaBadge(result.x025)}</div>` : ''}
        ${result.x0.length > 0 ? `<div class="w-row"><b class="mult x0">0x</b> ${creaBadge(result.x0)}</div>` : ''}
    </div>
`;
    } catch (e) { 
        console.error(e);
        container.innerHTML = "<span style='color:red'>Error.</span>"; 
    }
}
    </script>
</body>
</html>