<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>PokÃ©-Tournament Didi Luca</title>
    <link rel="icon" type="image/png" href="immagini/magikarp.png">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style-index.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div id="loading-screen">
    <div class="pokeball-loader"></div>
    <p>Please wait</p>
</div>

    <div class="news-ticker">
        <div class="ticker-wrap" id="lastMatchTicker">
            <div class="ticker-item">           Loading last match info...</div>
        </div>
    </div>

    <div class="main-wrapper">
    
    <div id="leaderboardContainer" class="cards-stack"></div>

        <a href="matches.html" class="btn-global-archive">MATCH ARCHIVE</a>
        <div class="chart-container-right">
        <canvas id="progressionChart"></canvas>
    </div>

        </div>

</div>


<script>

    async function inizializzaPagina() {
    try {
        // Avviamo i caricamenti della Home e aspettiamo che finiscano
        // Usiamo Promise.all per caricarli in contemporanea (piÃ¹ veloce)
        await Promise.all([
            caricaHome(),
            creaGraficoAndamento()
        ]);
        
        // Se hai elaboraBadge() anche qui, scommentalo:
        // await elaboraBadge(); 

    } catch (e) {
        console.error("Errore nel caricamento dati della Home:", e);
    } finally {
        // Nascondi la schermata di caricamento solo quando tutto Ã¨ pronto
        const loader = document.getElementById('loading-screen');
        if (loader) {
            loader.style.opacity = '0';
            // Aspettiamo che la transizione CSS finisca prima di mettere display: none
            setTimeout(() => {
                loader.style.display = 'none';
            }, 500);
        }
    }
}

// Avvia tutto al caricamento della pagina
window.onload = inizializzaPagina;

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRBD7fZsWUtQ-UqcSaG-2lzeQnbxUdCUlTc8D6b4dCmSLq4-sDpIJGVzKmwwZF0p1uF-Ln3--4jpGk/pub?gid=1283277155&single=true&output=csv';
    const csvDidiTeams = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRBD7fZsWUtQ-UqcSaG-2lzeQnbxUdCUlTc8D6b4dCmSLq4-sDpIJGVzKmwwZF0p1uF-Ln3--4jpGk/pub?gid=1913835106&single=true&output=csv';
    const csvLuTeams = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRBD7fZsWUtQ-UqcSaG-2lzeQnbxUdCUlTc8D6b4dCmSLq4-sDpIJGVzKmwwZF0p1uF-Ln3--4jpGk/pub?gid=589704271&single=true&output=csv';

function getGifUrl(pName) {
    if (!pName) return "";
    const urlName = pName.toLowerCase().replace(/ /g, '-').replace(/[.'Ã©]/g, '');
    return `https://play.pokemonshowdown.com/sprites/ani/${urlName}.gif`;
}

function getGifUrl(pName) {
    if (!pName) return "";
    const urlName = pName.toLowerCase().replace(/ /g, '-').replace(/[.'Ã©]/g, '');
    return `https://play.pokemonshowdown.com/sprites/ani/${urlName}.gif`;
}

async function caricaHome() {
    try {
        const [resMain, resDidi, resLu] = await Promise.all([
            fetch(csvUrl + '&t=' + new Date().getTime()).then(r => r.text()),
            fetch(csvDidiTeams + '&t=' + new Date().getTime()).then(r => r.text()),
            fetch(csvLuTeams + '&t=' + new Date().getTime()).then(r => r.text())
        ]);

        const righeTutte = resMain.split(/\r?\n/).filter(r => r.trim() !== "").map(r => r.split(','));
        const dbDidi = resDidi.split(/\r?\n/).filter(r => r.trim() !== "").map(r => r.split(','));
        const dbLu = resLu.split(/\r?\n/).filter(r => r.trim() !== "").map(r => r.split(','));

        const rLuca = righeTutte[1]; 
        const rDidi = righeTutte[2]; 
        const rMatch = righeTutte[3];

        if (!rLuca || !rDidi) return;

        const giocatori = [
            { nome: "LU", punti: parseInt(rLuca[1]) || 0, w: rLuca[2], l: rLuca[3], setW: rLuca[4], setL: rLuca[5], ultimoTeam: rMatch[2], database: dbLu, isLu: true },
            { nome: "DIDI", punti: parseInt(rDidi[1]) || 0, w: rDidi[2], l: rDidi[3], setW: rDidi[4], setL: rDidi[5], ultimoTeam: rMatch[3], database: dbDidi, isLu: false }
        ];

        giocatori.sort((a, b) => b.punti - a.punti);

        const leaderboardDiv = document.getElementById('leaderboardContainer');
        leaderboardDiv.innerHTML = giocatori.map((g, index) => {
            const themeClass = g.isLu ? 'lu-theme' : 'didi-theme';
            const rankClass = index === 0 ? 'rank-1' : 'rank-2';
            
            let pokemonHtml = '<div class="external-pokemon-grid">';
            const teamRow = g.database.find(row => row[0] && row[0].trim().toLowerCase() === g.ultimoTeam.trim().toLowerCase());

            if (teamRow) {
                const teamIdx = g.database.indexOf(teamRow);
                const itemRow = g.database[teamIdx + 2]; // Riga Strumenti (+2)
                const abiRow = g.database[teamIdx + 1];  // Riga AbilitÃ  (+1)
                const evRow = g.database[teamIdx + 7];   // Riga EV (+7)

                for (let i = 1; i <= 6; i++) {
    const pName = teamRow[i] ? teamRow[i].trim() : "";
    const itemName = (itemRow && itemRow[i]) ? itemRow[i].trim() : "";
    
    if (pName) {
        let itemUrl;
        if (itemName && itemName.toLowerCase() !== "none" && itemName !== "") {
            const itemUrlName = itemName.toLowerCase().replace(/ /g, '-').replace(/[.'Ã©]/g, '');
            itemUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/${itemUrlName}.png`;
        } else {
            itemUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png`;
        }

        const abi = (abiRow && abiRow[i]) ? abiRow[i].trim() : "N/D";
        const evs = (evRow && evRow[i]) ? evRow[i].trim() : "N/D";
        const mosse = [
            g.database[teamIdx + 3][i], g.database[teamIdx + 4][i],
            g.database[teamIdx + 5][i], g.database[teamIdx + 6][i]
        ].map(m => m ? m.trim() : "-");

        const positionClass = (i <= 2) ? "top-row" : "";

pokemonHtml += `
    <div class="pkm-slot tooltip-${rankClass}">
        <img src="${getGifUrl(pName)}" class="pkm-gif">
        <img src="${itemUrl}" class="hold-item-icon" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'">
        
        <div class="home-pkm-tooltip">
            <div class="tooltip-header">${pName.toUpperCase()}</div>
            <div class="tooltip-info">âœ¨ ${abi}</div>
            <div class="tooltip-info">ðŸ“Š ${evs}</div>
            <div class="tooltip-moves-grid">
                ${mosse.map(m => `<span class="mini-move">${m}</span>`).join('')}
            </div>
        </div>
    </div>`;

    } else {
        pokemonHtml += `<div class="pkm-slot empty"></div>`;
    }
}
            }
            pokemonHtml += '</div>';

            return `
            <div class="leaderboard-row ${rankClass}">
                ${pokemonHtml}
                <div class="player-card ${themeClass}">
                    <div class="card-inner">
                        <div class="left-section">
                            <div class="player-avatar">
                                <img src="${g.isLu ? 'immagini/lance.png' : 'immagini/sage.png'}">
                            </div>
                            <div class="player-info">
                                <h2>${g.nome}</h2>
                                <div class="punti-main">${g.punti}</div>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <a href="${g.isLu ? 'page-lu.html' : 'page-didi.html'}" class="btn-action stats">STATS</a>
                            <a href="${g.isLu ? 'box-lu.html' : 'box-didi.html'}" class="btn-action box">BOX</a>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-group"><span class="stat-label">W/L</span><b class="stat-value">${g.w}-${g.l}</b></div>
                        <div class="stat-group"><span class="stat-label">SET</span><b class="stat-value">${g.setW}-${g.setL}</b></div>
                    </div>
                </div>
            </div>`;
        }).join('');

        if (rMatch && rMatch[0]) {
            const tickerWrap = document.getElementById('lastMatchTicker');
            const testoNews = ` BREAKING NEWS -- ${rMatch[0]} -- Last match -- ${rMatch[1]} -- LU [${rMatch[4]}] vs DIDI [${rMatch[5]}] -- Teams: ${rMatch[2]} (LU) vs ${rMatch[3]} (DIDI) -- Points scored: LU ${rMatch[6]} - DIDI ${rMatch[7]} -- `;
            tickerWrap.innerHTML = `<div class="ticker-item">${testoNews}</div><div class="ticker-item">${testoNews}</div>`;
        }
    } catch (e) { console.error("Home loading error", e); }
}

function mostraTooltipHome(id) {
    const tt = document.getElementById(`tooltip-${id}`);
    if (tt) tt.style.display = 'block';
}

function nascondiTooltipHome(id) {
    const tt = document.getElementById(`tooltip-${id}`);
    if (tt) tt.style.display = 'none';
}

async function creaGraficoAndamento() {
    const csvMatchesUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRBD7fZsWUtQ-UqcSaG-2lzeQnbxUdCUlTc8D6b4dCmSLq4-sDpIJGVzKmwwZF0p1uF-Ln3--4jpGk/pub?gid=1971788122&single=true&output=csv';
    
    try {
        const response = await fetch(csvMatchesUrl + '&t=' + new Date().getTime());
        const data = await response.text();
        const rows = data.split(/\r?\n/).slice(1).map(r => r.split(','));

        let datePunti = {}; 
        rows.forEach(row => {
            const dataMatch = row[1]; // Colonna B: Data
            const puntiLu = parseInt(row[9]) || 0; 
            const puntiDidi = parseInt(row[8]) || 0; 
            
            if (dataMatch && dataMatch.trim() !== "") {
                if (!datePunti[dataMatch]) {
                    datePunti[dataMatch] = { lu: 0, didi: 0 };
                }
                datePunti[dataMatch].lu += puntiLu;
                datePunti[dataMatch].didi += puntiDidi;
            }
        });

        const tutteLeDate = Object.keys(datePunti);
        const ultimeDate = tutteLeDate.slice(-5);

        const dateLabels = ultimeDate.map(d => {
            const parti = d.split('/');
            return parti.length >= 2 ? `${parti[0]}/${parti[1]}` : d;
        });

        let cumulativoLu = 0, cumulativoDidi = 0;
        let datiLu = [], datiDidi = [];

        tutteLeDate.forEach(d => {
            cumulativoLu += datePunti[d].lu;
            cumulativoDidi += datePunti[d].didi;
            if (ultimeDate.includes(d)) {
                datiLu.push(cumulativoLu);
                datiDidi.push(cumulativoDidi);
            }
        });

        const ctx = document.getElementById('progressionChart').getContext('2d');
        if (window.myChart) { window.myChart.destroy(); }

        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dateLabels,
                datasets: [
                    { 
                        label: 'LU', 
                        data: datiLu, 
                        borderColor: '#8e44ad', 
                        backgroundColor: '#8e44ad', 
                        tension: 0.4, 
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 6 // Il pallino si ingrandisce leggermente al passaggio
                    },
                    { 
                        label: 'DIDI', 
                        data: datiDidi, 
                        borderColor: '#31c489', 
                        backgroundColor: '#31c489', 
                        tension: 0.4, 
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(20, 20, 20, 0.9)', // Sfondo scuro
                        padding: 10,
                        displayColors: true, // Mostra il quadratino/pallino colorato
                        boxWidth: 8,
                        boxHeight: 8,
                        boxPadding: 5,
                        usePointStyle: true, // Trasforma il quadratino del tooltip in un pallino
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1,
                        bodyFont: {
                            family: 'Josefin Sans',
                            size: 14,
                            weight: 'bold'
                        },
                        callbacks: {
                            // Rimuove la data (titolo) dal tooltip
                            title: () => null,
                            // Rimuove il nome (LU/DIDI) e mostra solo il numero
                            label: function(context) {
                                return context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { 
                            color: '#fff',
                            stepSize: 10,
                            font: {
                                family: 'Josefin Sans',
                                size: 11,
                                weight: 'bold'
                            }
                        }, 
                        grid: { color: 'rgba(255,255,255,0.1)' } 
                    },
                    x: { 
                        ticks: { 
                            color: '#fff',
                            font: {
                                family: 'Josefin Sans',
                                size: 10
                            }
                        }, 
                        grid: { display: false } 
                    }
                },
                layout: {
                    padding: { top: 15, bottom: 5, left: 5, right: 10 }
                }
            }
        });
    } catch (e) { console.error("Errore grafico:", e); }
}

// Avvia la creazione del grafico
creaGraficoAndamento();

caricaHome();
</script>
</body>
</html>